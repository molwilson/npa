---
title: "NPA long-term reef monitoring"
author: "Molly Wilson"
date: "7/20/2022"
output: 
  html_document:
    code_folding: hide
---
# {.tabset}

```{r, message = F, warning = F, echo = F}
library(tidyverse)
library(here) 
library(readxl) 
library(janitor)
library(snakecase) # for adjusting capitalization of text within data (e.g., species names)
library(lubridate) # for extracting different components of date data
library(knitr) # for including tables
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Fish

What stats/graphs do we want?
- overall abundance by group at each site/date
- overall abundance by group over time (panel?)
- size distributions within each group (panel)

To do list:
- add herbivore-specific
- add option for custom simple graphs of just one site/year
- fix labels and colors
```{r}
fish <- read_excel(here("reef monitoring", "data", "npa_ltm.xlsx"), sheet = "fish") %>%  
  clean_names() %>%
  mutate(date = ymd(date),
         year = year(date))

fish_groups <- c("Doctorfish", "Snapper") # names of fish groups that have size data


# calculating density of all fish by site and date
fish_density_tot <- fish %>%
  filter(group %in% fish_groups) %>%
  group_by(date, year, transect) %>%
  summarize(count_tot = sum(count),
            density = count_tot/60) %>%
  group_by(date, year) %>%
  summarize(count_mean = mean(count_tot),
            density_mean = mean(density),
            density_se = sd(density)/sqrt(n()))

ggplot(fish_density_tot, aes(x = as.character(year), y = density_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = density_mean - density_se, ymax = density_mean + density_se), width = .2,
                 position = position_dodge(.9)) +
  theme_bw()

# calculating density of each group by site and date (regardless of size bin)
fish_density_grp <- fish %>%
  expand(nesting(site, date, year, transect), group) %>%
  left_join(fish %>%
              select(site, date, transect, group, count) %>%
              group_by(site, date, transect, group) %>%
              summarize(count = sum(count))) %>%
  mutate(count = if_else(is.na(count), 0, count), # replaces all entries not observed with 0
         density = count/60) %>%
  group_by(site, date, year, group) %>%
  summarize(count_mean = mean(count),
            density_mean = mean(density),
            density_se = sd(density)/sqrt(n()))

ggplot(fish_density_grp, aes(x = factor(year), y = density_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = density_mean - density_se, ymax = density_mean + density_se), width = .2,
                 position = position_dodge(.9)) +
  facet_grid(site ~ group) +
  theme_bw()

# calculating density of fish groups of each size bin by site and date 
fish_density_size <- fish %>%
  filter(group %in% c("Doctorfish", "Snapper")) %>%
  expand(nesting(site, date, year, transect), group, size_bin) %>% # expand df to include all possible groups/size bins
  left_join(fish %>%
              filter(group %in% c("Doctorfish", "Snapper")) %>%
              select(site, date, transect, group, size_bin, count)) %>%
  mutate(count = if_else(is.na(count), 0, count),
         density = count/60) %>% 
  group_by(site, date, year, group, size_bin) %>%
  summarize(count_mean = mean(count),
            density_mean = mean(density),
            density_se = sd(density)/sqrt(n()))

ggplot(fish_density_size, aes(x = size_bin, y = density_mean, fill = factor(year))) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = density_mean - density_se, ymax = density_mean + density_se), width = .2,
                 position = position_dodge(.9)) +
  facet_grid(group ~ site) +
  theme_bw()
```

# Benthic
What stats/graphs do we want?
- mean macroalgal and turf canopy heights by site and date
- photo transect data will be separate?
```{r}
benthic <- read_excel(here("reef monitoring", "data", "npa_ltm.xlsx"), sheet = "benthic") %>%  
  clean_names() %>%
   mutate(date = ymd(date),
         year = year(date))

benthic_heights <- benthic %>%
  pivot_longer(cols = ends_with("height"), #turn two algal height columns into two rows, will help for graphs/analysis
               names_to = "algal_type", # create column to distinguish whether height is macroalgae vs turf algae
               names_pattern = "(.*)_height", # removes "height" from end of new "algal_type" cell
               values_to = "height") %>% # values are identified as heights
  group_by(date, year, site, algal_type, transect) %>%
  summarize(height = mean(height)) %>%
  group_by(date, year, site, algal_type) %>%
  summarize(height_mean = mean(height),
            height_se = sd(height)/sqrt(n()))

ggplot(benthic_heights, aes(x = algal_type, y = height_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = height_mean - height_se, ymax = height_mean + height_se), width = .2,
                 position = position_dodge(.9)) +
  facet_grid(site ~ year) +
  theme_bw()
```

# Invertebrates
What stats/graphs do we want?
- abundance by site over time
```{r}
inverts <- read_excel(here("reef monitoring", "data", "npa_ltm.xlsx"), sheet = "inverts") %>%  
  clean_names() %>%
  mutate(date = ymd(date),
         year = year(date))

invert_density <- inverts %>%
  expand(nesting(site, date, year, transect), group) %>%
  left_join(inverts %>%
              select(site, date, year, transect, group, count)) %>%
  mutate(density = count / 60) %>%
  group_by(date, year, site, group) %>%
  summarize(count_mean = mean(count),
            density_mean = mean(density),
            density_se = sd(density)/sqrt(n()))

ggplot(invert_density, aes(x = factor(year), y = density_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = density_mean - density_se, ymax = density_mean + density_se), width = .2,
                 position = position_dodge(.9)) +
  facet_grid(site ~ group) +
  theme_bw()

ggplot(invert_density, aes(x = group, y = density_mean)) +
  geom_col() +
  geom_errorbar(aes(ymin = density_mean - density_se, ymax = density_mean + density_se), width = .2,
                 position = position_dodge(.9)) +
  facet_grid(site ~ year) +
  theme_bw()
```